#!/usr/bin/env perl

use FindBin qw/$Bin/;
use local::lib "$Bin/local/";
use Modern::Perl '2015';
use experimental qw/signatures/;
use autodie;
use Parallel::ForkManager;
use Pod::Usage;
use Getopt::Lucid qw/:all/;

my @specs = (
    Param("megan|m")->default($ENV{'HOME'}."/local/bin/MEGAN"),
    Param("meganLicense|l")->default($ENV{'HOME'}."/MEGAN5-academic-license.txt"),
    Switch("format|f")->default(0),
    Param("outputDIR|o")->default(""),
    Param("contigs|c"),
    Param("refseqKO|r")->default("/export2/home/uesu/db/konr/"),
    Param("threads|t")->default(1),
    Param("prefix|p"),
    Switch("help|h"),
    Param("windowSize|w")->default(200)
);

my $opt = Getopt::Lucid->getopt( \@specs )->validate;
pod2usage(-verbose=>2) if $opt->get_help;
$opt->validate({'requires' => ['format','refseqKO','outputDIR','contigs']});

my $outputDir     = $opt->get_outputDIR;
my $refseqProtDB  = $opt->get_refseqKO;
my $MAX_PROCESSES = $opt->get_threads;
my $toFormat      = $opt->get_format;
my $contigDir     = $opt->get_contigs;
my $meganPath     = $opt->get_megan;
my $meganLicense  = $opt->get_meganLicense;
system "mkdir $outputDir";

say "## Using $MAX_PROCESSES threads";

say "## Blasting"; ##################################################
system "script/pAss.00.blast.pl --threads $MAX_PROCESSES --kodb $refseqProtDB --output $outputDir/pAss00 --format $toFormat --contigs $contigDir";

say "MEGAN aln"; ##################################################
my $pm0 = Parallel::ForkManager->new($MAX_PROCESSES);
foreach my $ko (`ls $outputDir/pAss00/ | sed s/\.blastx//`)
{   chomp $ko;
    $pm0->start and next;
    say "Processing $ko";
    system "mkdir -p $outputDir/pAss01/$ko";
    system "script/pAss.01.msa.pl --queryFasta $contigDir/$ko/454AllContigs.fna --blastFile $outputDir/pAss00/$ko.blastx --megan $meganPath --meganLicense $meganLicense --output $outputDir/pAss01/$ko";
    $pm0->finish;
}
$pm0->wait_all_children;

say "## Generating MSA"; ##################################################
my $pm = Parallel::ForkManager->new($MAX_PROCESSES);
foreach my $ko (`ls $outputDir/pAss01/ | grep -v log`) #need to change this; this is hard coded
{   chomp $ko;
    $pm->start and next;
    system "script/pAss.03.master.msa.pl --refseqFasta $refseqProtDB/ko:$ko --msadir $outputDir/pAss01/$ko --out $outputDir/pAss03 --ko $ko";
    $pm->finish;
}
$pm->wait_all_children;


say "## MSA Diagnostics"; #################################################
system "mkdir $outputDir/pAss04";
system "mkdir $outputDir/pAss10";

my $pm3 = Parallel::ForkManager->new($MAX_PROCESSES);
foreach my $ko (`ls $outputDir/pAss03/ | grep -v temp | sed s/\.msa//g`)
{
    chomp $ko;
    $pm3->start and next;
    system "script/pAss.04.msa2group.pl --msa $outputDir/pAss03/$ko.msa --outputPrefix $outputDir/pAss04/$ko";
    system "script/pAss.10.maxDiversity.pl --minLength 200 --inputFile $outputDir/pAss03/$ko.msa --outputDir $outputDir/pAss10/$ko";
    $pm3->finish;
}
$pm3->wait_all_children;

say "## Output MaxDiveristy Region";
system "mkdir $outputDir/pAss11";
my $pm4 = Parallel::ForkManager->new($MAX_PROCESSES);
foreach my $ko (`ls $outputDir/pAss10/`)
{
    chomp $ko;
    $pm4->start and next;
    system "script/pAss.11.best.window.r $outputDir/pAss10/$ko/$ko $outputDir/pAss03/$ko.msa $outputDir/pAss11/";
    $pm4->finish;
}
$pm4->wait_all_children;

#Documentation
=pod

=head1 NAME

    maxDiversity

=head1 DESCRIPTION

    Before running maxDiversity the following is required

=over 4

=item Protein Reference Sequences

    Prokaryotic sequences only,  grouped by KOs (eg. K00001.fa, K00002.fa)

=item Contigs

    Contigs should be in found in a root directory separated by KO ids (NEWBLER)

    root/directory
    |-- K00001
    |   |-- 454AllContigs.fna
    |   |-- 454AllContigs.qual
    |   |-- 454ContigGraph.txt
    |   |-- ...
    |   `-- sff
    |-- K00002
    |   |-- 454AllContigs.fna
    |   |-- 454AllContigs.qual
    |   |-- 454ContigGraph.txt
    |   |-- ...
    |   `-- sff

=back

=head1 OPTIONS

=over 4

=item --megan -m

    File path pointing to MEGAN executable. Defaults to $HOME/loca/bin/MEGAN

=item --meganLicense

    File Path poining to the MEGAN5 academic license

=item --contigs, -c

    the path to dir containing contigs fna files

        data/contigs/
        |-- K00001
        |   `-- 454AllContigs.fna
        |-- K00002
        |   `-- 454AllContigs.fna
        |-- K00003
        |   `-- 454AllContigs.fna
        |-- K00004
        |   `-- 454AllContigs.fna
        |-- K00005
        |   `-- 454AllContigs.fna
        |-- K00007
        |   `-- 454AllContigs.fna
        |-- K00008
        |   `-- 454AllContigs.fna
        |-- K00009
        |   `-- 454AllContigs.fna
        |-- K00010
        |   `-- 454AllContigs.fna
        `-- K00011
            `-- 454AllContigs.fna`

=item --format, -f

    Switch for running formatdb / makeblastdb (for times when you need to rerun the pipeline and do not wish to rerun this step)

=item --refseqKO, -r

    the prefix to which to append the KO id eg. /export2/home/uesu/db/konr/ko:

    note the reference sequence files should be named in the same convention as seen in the example

=item --threads, -t

    the number of threads to use

=item --prefix, -p

    the location for all the intermediate files

=item --windowSize -w

    the size of the window when looking for a maxDiversity region

=item --help

    throws up the help message

=back

=cut
